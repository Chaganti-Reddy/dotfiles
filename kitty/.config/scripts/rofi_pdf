#!/bin/bash

# === CONFIGURATION ===
SEARCH_DIRS=( "$HOME/Documents" "$HOME/Downloads" "/mnt/Karna/" )
CACHE_FILE="$HOME/.cache/multi_pdf_list"
PDF_VIEWER="okular"  # fallback: will default to xdg-open if empty
SCAN_INTERVAL=300
ROFI_CMD="rofi -dmenu -i -theme ~/.config/rofi/dt-center.rasi -p PDF"

# === BUILD FIND COMMAND ===
build_find_command() {
    for dir in "${SEARCH_DIRS[@]}"; do
        [ -d "$dir" ] && find "$dir" -type f -iname '*.pdf'
    done
}

# === REFRESH CACHE ===
refresh_cache() {
    echo "🔍 Refreshing PDF list..." >&2
    > "$CACHE_FILE"
    build_find_command | while IFS= read -r file; do
        filename=$(basename "$file")
        dirpath=$(dirname "$file")
        display_path="${dirpath/#$HOME/~}"
        echo "$filename [${display_path}]|$file"
    done | sort > "$CACHE_FILE"
    touch "$CACHE_FILE"
}

# === MANUAL REFRESH MODE ===
if [[ "$1" == "--refresh" ]]; then
    refresh_cache
    echo "✅ PDF list manually refreshed."
    exit 0
fi

# === INIT CACHE ===
[ ! -f "$CACHE_FILE" ] && { mkdir -p "$(dirname "$CACHE_FILE")"; refresh_cache; }

# === CHECK IF STALE ===
now=$(date +%s)
last_update=$(date -r "$CACHE_FILE" +%s)
(( now - last_update > SCAN_INTERVAL )) && refresh_cache &

# === LOAD LIST & ADD REFRESH OPTION ===
mapfile -t options < <(cut -d'|' -f1 "$CACHE_FILE")
options+=("🔁 Refresh PDF List")

# === SHOW ROFI MENU ===
selection=$(printf "%s\n" "${options[@]}" | $ROFI_CMD)
[[ -z "$selection" ]] && exit 0

# === HANDLE REFRESH OPTION ===
if [[ "$selection" == "🔁 Refresh PDF List" ]]; then
    refresh_cache
    notify-send "PDF Cache Refreshed" "List updated at $(date +'%H:%M:%S') ✅"
    exit 0
fi

# === OPEN SELECTED FILE ===
full_path=$(awk -F'|' -v sel="$selection" '$1 == sel {print $2}' "$CACHE_FILE")
[[ -n "$full_path" ]] && "${PDF_VIEWER:-xdg-open}" "$full_path" &>/dev/null &

